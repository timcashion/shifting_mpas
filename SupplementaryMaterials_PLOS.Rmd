---
title: "Shifting Seas, Shifting Boundaries: Dynamic Marine Protected Area designs for a Changing Climate"
author: "Tim Cashion^1^ *, Tu Nguyen^2^, Talya ten Brink^3^ ^, Anne Mook^4^ ^, Juliano Palacios-Abrantes^5^ ^, Sarah M. Roberts^6^ ^"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  #bookdown::html_document2
  bookdown::word_document2
bibliography: MyCollection.bib
always_allow_html: yes
biblio-style: "apalike"
---

*Corresponding author. t.cashion@oceans.ubc.ca; trcashion@gmail.com
^ These authors contributed equally. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning= F, message=F)
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
packages <- c(
  "tidyverse", #data manipulation and plotting
  "wesanderson", #Awesome colour schemes
  "rmarkdown", #rmarkdown document formatting and functions
  "knitr" #for printing tables with 'kable' 
)
ipak(packages)
options(knitr.kable.NA = '')

source("./R/end_of_century_average.R")
source("./R/spatial_maps_segment_plots.R")

```

```{r data, echo=FALSE, warning=FALSE, message=FALSE}


#For data cleaning files (converting EwE outputs to tidy format), see R script of 'OutputDataCleaning.R' 

mpa_labels <- tibble(design = c("MPA_Horiz_Static", 
                                "MPA_Square_Static", 
                                "MPA_Square_Shifting", 
                                "MPA_Vert_Static", 
                                "MPA_Network_Static", 
                                "MPA_Network_Shifting", 
                                "NoMPA"),
                     mpa_label = c("Horizontal Static", 
                                "Square Static", 
                                "Square Shifting", 
                                "Vertical Static", 
                                "Network Static", 
                                "Network Shifting", 
                                "No MPA"))

average_data <- data.table::fread("/nfs/mpasandclimatechange-data/Data/AnchovyBay/DataOutputs/AnnualAverageData_tidy.csv")
average_data <- average_data %>% 
  rename(year=Year) %>% 
  mutate(year=year-1) %>% 
  filter(scenario==10)
mpa_data <- read_csv("/nfs/mpasandclimatechange-data/Data/AnchovyBay/DataOutputs/MPAData_tidy.csv")
#temporarily limit to 5% percent scenario before building out others.
mpa_data <- mpa_data %>%
  mutate(scenario = gsub(scenario, pattern="MPA Scenario ", replacement = "")) %>% 
  mutate(scenario = gsub(scenario, pattern=" Percent", replacement = "")) %>% 
  mutate(scenario = as.numeric(scenario)) %>% 
  filter(scenario == 10)

# spatial_data_raw <- read_csv("nfs/mpasandclimatechange/data/AnchovyBay/DataOutputs/SpatialData_tidy.csv") #This file is large and takes time to load. Any way to truncate for quicker analysis and outputs? 
spatial_data <- data.table::fread("/nfs/mpasandclimatechange-data/Data/AnchovyBay/DataOutputs/SpatialData_tidy_10.csv")
price_data <- read_csv("/nfs/mpasandclimatechange-data/Data/AnchovyBay/DataOutputs/PriceData_tidy.csv")
#Need to revisit elasticity data as it seems very off
price_data$elasticity[price_data$elasticity>=2] <- 1.99

port_data <- read_csv("/nfs/mpasandclimatechange-data/Data/AnchovyBay/DataOutputs/PortData_tidy.csv")

average_fleet_data <- average_data %>% 
  filter(grepl(group, pattern="\\|"))

#Price elasticity:
orig_catch <- average_fleet_data %>% 
  filter(year==1 & RCP=="RCP2.6" & design=="NoMPA" & scenario=="10") %>% 
  select(group, value) %>% 
  rename(orig_catch = value)
average_fleet_data <- average_fleet_data %>% 
  left_join(price_data) %>% 
  left_join(orig_catch) %>% 
  rename(catch=value) %>% 
  mutate(PercChange = ((catch-orig_catch)/orig_catch))

average_fleet_data$PercChange[average_fleet_data$PercChange>=0.35] <- 0.35
average_fleet_data$PercChange[average_fleet_data$PercChange<=-0.35] <- -0.35


average_fleet_data <- average_fleet_data %>% 
  mutate(CurrentPrice = Price*(((-1*elasticity)*PercChange)+1))  %>% 
  mutate(value=CurrentPrice*catch)

elasticity_adjusted_prices <- average_fleet_data %>% 
  select(year, fg, design, RCP, CurrentPrice)

spatial_catch_data <- spatial_data %>% 
  filter(type=="Catch") %>% 
  left_join(elasticity_adjusted_prices) %>%
  rename(catch=value) %>% 
  mutate(value=CurrentPrice*catch)

#unique(spatial_data$type)
mpa_legend <- tibble(mpa=c(0,1,2), MPA=c("Outside", "Inside", "Adjacent"))
#Be careful with plotting the spatial data. To achieve the originally designed visual version in plots, the row_num (i.e. the y-axis) needs to be reversed as the original layout goes from 1 at the top to 20 at the bottom. Plots by default have higher values at the top and lower values at the bottom (i.e., the opposite of our grid layout). 

```

```{r mpa-spatial-prep}
mpa_spatial <- left_join(spatial_data, mpa_data) 
mpa_spatial$mpa[which(mpa_spatial$design=="NoMPA")] <- 0
test <- mpa_spatial[is.na(mpa_spatial$mpa),] 
mpa_spatial <- mpa_spatial %>% 
  left_join(mpa_legend)
mpa_spatial$MPA <- as.factor(mpa_spatial$MPA)
mpa_spatial$MPA <- fct_relevel(mpa_spatial$MPA, "Outside", after=0)
mpa_spatial$MPA <- fct_relevel(mpa_spatial$MPA, "Inside", after=1)

```

```{r plot-design}

zissou_continuous <- wes_palette(name = "Zissou1", n=100, type = c("continuous"))
zissou_discrete_3 <- wes_palette(name = "Zissou1")[c(1,3,5)]
#print(zissou_discrete_3)
theme_set(theme_classic())
zissou_blue <- wes_palette("Zissou1")[1]
zissou_red <- wes_palette("Zissou1")[5]


```

# Supplemental Methods
 

### Model construction 
 

```{r ecopath}
ecopath <- read_csv("./InputData/anchovybay_basicinput.csv", na="")
options(knitr.kable.NA = '')
kable(ecopath, caption= "Basic input parameters for Anchovy Bay ecopath model (Christensen, 2018).")
```


```{r diets}
diets <- read_csv("./InputData/anchovybay_dietmatrix.csv")
options(knitr.kable.NA = '')
colnames(diets)[1] <- "Group Number"
kable(diets, caption= "Diet matrix for Anchovy Bay ecopath model (Christensen, 2018).")
```


```{r price}
price <- read_csv("./InputData/Sardine Bank-Off-vessel price.csv")
price$`Group name`[which(price$`Group name`=="Mackerel ad")] <- "Mackerel adult"
price <- price %>% 
  filter(`Group name` %in% c("Seals", "Cod", "Whiting", "Mackerel adult", "Anchovy", "Shrimp")) %>% 
  select(-c(X1, X8))
colnames(price) <- gsub(colnames(price), pattern="EUR", replacement= "$ ")
kable(price, caption="Ex-vessel prices used for this study. Obtained from Christensen, 2018.")
```

```{r price-elasticity}
price_sens <- read_csv("./InputData/pricesens.csv")
kable(price_sens, caption="Literature review of price elasticities corresponding to functional groups in this study. Obtained from Asche et al. 2005. Dependent Variable: p:price; q: quantity.")
```



```{r temp-viz, fig.cap="Temperature gradient applied to our ecosystem. Red dot indicates the fishing port location."}
temp <- read.csv("./InputData/SardineBanks-Temperature_BaseYear.csv")
temp <- temp %>% pivot_longer(cols=X1:X20)
temp <- temp %>% 
  mutate(name=gsub(name, pattern="X", replacement="")) %>% 
  mutate(name= as.numeric(name),
         X = as.numeric(X)) %>% 
  rename(col=name,
         row=X)
port = tibble(col=10, row=20, value=0)
temp %>% ggplot(aes(x=col, y=rev(row), fill=value)) +
  geom_tile() +
  ylab("") +
  xlab("") + 
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) + 
  theme_classic() + 
  geom_point(data=port, aes(x=col, y=rev(row)), size=4, color="red") + 
  labs(fill="Temperature", size="Port") + 
  NULL
ggsave("./Figures/Supplementary/S1_Fig.tiff")

```

```{r static-mpa-visuals, fig.cap="Static MPA designs"}


mpa_visual <- mpa_data %>% 
  left_join(mpa_legend) %>% 
  left_join(mpa_labels) %>% 
  filter(!(grepl(design, pattern="Shifting"))) %>% 
  filter(design != "MPA_NoMPA") %>% 
  ggplot(aes(x=col_num, y=rev(row_num), fill=as.factor(MPA))) +
  geom_tile(color="grey") +
  facet_wrap(~mpa_label) +
  ylab("") + 
  xlab("") +
  scale_color_manual(values="grey") + 
  scale_fill_manual(values = rev(zissou_discrete_3)) +
  labs(fill="Area type") + 
  NULL
print(mpa_visual)
# ggsave("./VisualOutputs/Static MPA Designs.png", dpi=300, width=8.5, height=11, units="in")
ggsave("./Figures/Supplementary/S2_Fig.tiff", dpi=300, width=8.5, height=11, units="in")

```

```{r shifting-mpa-visuals, fig.cap="Shifting MPA designs with caption indicating Year"}

mpa_visual_shifting <- mpa_data %>% 
  left_join(mpa_legend) %>% 
  left_join(mpa_labels) %>% 
  filter(grepl(design, pattern="Shifting")) %>% 
  filter(year %in% c(0, 20, 40, 60, 80)) %>% 
  ggplot(aes(x=col_num, y=rev(row_num), fill=as.factor(MPA))) +
  geom_tile(color="grey") +
  facet_wrap(~mpa_label+year, nrow=2) +
  ylab("") + 
  xlab("") +
  scale_color_manual(values="grey") + 
  scale_fill_manual(values = rev(zissou_discrete_3)) +
  labs(fill="Area type") + 
  NULL
print(mpa_visual_shifting)
# ggsave("./VisualOutputs/Dynamic MPA Designs.png", dpi=300, width=8.5, height=11, units="in")
ggsave("./Figures/Supplementary/S3_Fig.tiff", dpi=300, width=8.5, height=11, units="in")

```

To ensure the effect we are focusing on is not driven by pre-existing traits related to habitat for foraging, we remove the habitat drivers from functional groups foraging behaviour. The result is that the species are constrained and influenced by environmental (i.e., temperature and primary productivity) drivers rather than limited by habitat type. This included removing the coastal margin of the Ecospace to not limit functional groups from the edge of the area. 

An important part of the Ecospace parameterization is the determination of dispersal values. Dispersal determines the average distance a functional group can travel in a year. As it determines how mobile or sessile a functional group is, it is expected to heavily influence the results of marine protected area simulations. The values for similar functional groups were used from [@beattie_marine_2001], and anchovy, benthos, and zooplankton were assumed to have the same values as herring, 'other macrobenthos, and copepods, respectively (Table \@ref(tab:disp)). The dispersal values of all functional groups were modified for the sensitivity analysis. 


```{r disp}
disp <- read.csv("./InputData/Anchovy Bay-Dispersal.csv")
disp <- disp %>% select(Group.name, Base.dispersal.rate)
colnames(disp) = c("Functional group", "Base dispersal rate (km/year)")
kable(disp, caption="Dispersal values used for Ecospace parameterization.")
```

The fishing fleets had a cost function applied based on distance, and their fishing effort is determined internally through a profit maximizing mechanism. Therefore, they exploit areas of high abundance over areas of low abundance given equal distances. For our specification, we had one port at the Northern end of the habitat halfway through the area (Figure \@ref(fig:temp-viz)). 

## Sensitivity analysis
Our sensitivity analysis is carried out by varying the base dispersal rate, which regulates the MPA spillover effect. To estimate the sensitivity to this parameter we varied this value by 25% and 50% in either direction (i.e., lower or higher base dispersal rates). We ran this second sensitivity analysis on three of our MPA designs (no MPAs, network static, and network shifting) under the 4$\^circ$ warming scenario.

When we alter the dispersal parameter, we find the results at the functional group level are altered only slightly at the end of the century (Figure \@ref(fig:sa-dispersal-fg)). In addition, when we look at the area with the most change, we see little variation in catch or biomass levels at the end of the century in cells adjacent to MPAs which theoretically would be most affected by this dispersal parameter (Figure \@ref(fig:sa-spillover)).  


```{r sa-dispersal-fg, echo=F, message=F, warning=F, fig.cap="Biomass by functional group (total for the ecosystem) under alternative spillover values compared to no MPA scenario at the end of the 21st century.", fig.width=11, fig.height=8}

sa_disp <- data.table::fread("/nfs/mpasandclimatechange-data/Data/AnchovyBay/DataOutputs/SA_SpatialData_tidy.csv")
sa_disp <- sa_disp %>% rename(group=fg)
sa_disp <- sa_disp %>% left_join(mpa_data)

excluded_fgs <- c("Zooplankton", "Benthos", "Phytoplankton", "Detritus")

decade1 <- seq(0,9,1)
decade2 <- seq(45,54,1)
decade3 <- seq(90,99,1)

sa_disp <- sa_disp %>% 
  mutate(TimePeriod = if_else(year %in% decade1, "Today", 
                              if_else(year %in% decade2, "Mid-Century", 
                                      if_else(year %in% decade3, "End of Century", ""))))

sa_disp$TimePeriod <- fct_relevel(sa_disp$TimePeriod, "Today", "Mid-Century", "End of Century")

sa_disp$dispersal <- fct_relevel(sa_disp$dispersal, "neg50", "neg25", "0", "pos25", "pos50")
sa_disp$dispersal <- fct_relabel(sa_disp$dispersal, gsub, pattern="pos", replacement="Positive ")

sa_disp$dispersal <- fct_relabel(sa_disp$dispersal, gsub, pattern="neg", replacement="Negative ")
#unique(sa_disp$dispersal)

sa_disp$group <- gsub(sa_disp$group, pattern=" ad", replacement= " adult")
sa_disp$group <- gsub(sa_disp$group, pattern=" juv", replacement= " juvenile")

sa_summary <- sa_disp %>%
  filter(TimePeriod != "") %>% 
  #filter(design %in% design_chosen) %>% 
  filter(!group %in% excluded_fgs) %>% 
  filter(RCP=="RCP8.5") %>% 
  group_by(group, TimePeriod, type, design, RCP, dispersal) %>%
  summarize(value=mean(value))

nompa_average <- sa_summary %>% 
  ungroup() %>% 
  filter(design=="NoMPA")  %>% 
  rename(baseline=value) %>% 
  select(-design)

sa_summary <- sa_summary %>% ungroup() %>% 
  filter(design!="NoMPA") %>% 
  filter(TimePeriod != "Today") %>% 
  filter(TimePeriod != "Mid-Century") %>% 
  left_join(nompa_average) %>% 
  mutate(value= ((value-baseline)/baseline)*100)

biomass_sa_plot <- sa_summary %>% 
  left_join(mpa_labels) %>% 
  filter(type=="Biomass") %>% 
  ggplot(aes(x=mpa_label, y=value, fill=value)) +
  geom_col() +
  coord_flip() +
  xlab("MPA design") + 
  ylab("Percent change in biomass") + 
  facet_wrap(~group +dispersal, ncol=5) + 
  scale_fill_gradientn(colors=rev(zissou_continuous)) + 
  geom_hline(yintercept = 0, lty='dashed', color = 'grey50') + 
  labs(fill="Percent change") + 
  NULL
biomass_sa_plot
#ggsave("./VisualOutputs/SA_biomass_dispersal.png", dpi=1200)
ggsave("./Figures/Supplementary/S4_Fig.tiff", dpi=300)

```


```{r sa-spillover, fig.cap="Catch and biomass in cells adjacent to MPAs under alternative spillover values at the end of the 21^st^ century.", fig.width=9, fig.height=6, dpi=600}
spillover_effect <- sa_disp %>% 
  filter(year >90) %>% 
  filter(mpa==2) %>% 
  filter(type != "Effort") %>% 
  group_by(type, design, dispersal, mpa) %>% 
  summarize(value=mean(value))

spillover_effect %>% 
  left_join(mpa_labels) %>% 
  ggplot(aes(x=dispersal, y=value, fill=type)) +
  geom_col() +
  #geom_errorbar(aes(x=dispersal, y=value, ymin=value-st_dev, ymax= value+st_dev)) +
  facet_wrap(~mpa_label + type, scales="free_y") +
  ylab(expression("Tonnes / km" ^2)) +
  xlab("Dispersal Change") + 
  theme(legend.position = "None") + 
  NULL
#ggsave("./VisualOutputs/SA_spillover_effect.png", dpi=1200)
ggsave("./Figures/Supplementary/S5_Fig.tiff", dpi=300)

```



## Supplemental results


```{r ecosystem-wide-results-from-paper, eval=T}

baseline_decade <- average_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year <=9) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2000s = mean(value_aggregate),
            stdev_2000s = sd(value_aggregate)) %>%
  mutate(se_2000s = stdev_2000s/sqrt(10))

end_of_century <- average_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year >=90 & year <99) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2090s = mean(value_aggregate),
            stdev_2090s = sd(value_aggregate)) %>%
  mutate(se_2090s = stdev_2090s/sqrt(9))


summary_table_revenue1 <- average_fleet_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year <= 9) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2090s = mean(value_aggregate),
            stdev_2090s = sd(value_aggregate)) %>%
  mutate(se_2090s = stdev_2090s/sqrt(10))

summary_table_revenue2 <- average_fleet_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year >=90 & year <99) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2090s = mean(value_aggregate),
            stdev_2090s = sd(value_aggregate)) %>%
  mutate(se_2090s = stdev_2090s/sqrt(9))



summary_table_temp_baseline <- baseline_decade %>% gather(key= variable, value=value, -RCP, -type, -design)
summary_table_temp_end_of_century <- end_of_century %>% gather(key= variable, value=value, -RCP, -type, -design)
summary_table_temp <- rbind(summary_table_temp_baseline, summary_table_temp_end_of_century)
summary_table_temp$type <- gsub(summary_table_temp$type, pattern=".*_", replacement="")
summary_table_temp$year <- gsub(summary_table_temp$variable, pattern=".*_", replacement="")
summary_table_temp$variable <- gsub(summary_table_temp$variable, pattern="_.*", replacement="")
summary_table_temp$aggregate <- paste(summary_table_temp$RCP, summary_table_temp$design, summary_table_temp$year, sep="/")
summary_table_temp$label <- paste(summary_table_temp$design, summary_table_temp$year, sep=" ")

summary_table <- summary_table_temp %>%
  filter(variable != "se")  %>%
  spread(key=variable, value=value)

summary_table_biomass <- summary_table %>% filter(type=="Biomass")
summary_table_catch <- summary_table %>% filter(type=="Catch")
summary_table_effort <- summary_table %>% filter(type=="Effort")

output_table_biomass <- summary_table_biomass %>%
  filter(year=="2090s") %>%
  mutate(value = paste(round(average, 1), " (", round(stdev,2), ")", sep="")) %>%
  select(-c( year,aggregate, label, average, stdev)) %>%
  spread(design, value=value) 

output_table_catch <- summary_table_catch %>%
  filter(year=="2090s") %>%
  mutate(value = paste(round(average, 1), " (", round(stdev,2), ")", sep="")) %>%
  select(-c( year,aggregate, label, average, stdev)) %>%
  spread(design, value=value) 

output_table_summary <- rbind(output_table_biomass, output_table_catch)


# output_table_summary <- output_table_summary %>% ungroup()
# colnames(output_table_summary) <- c("Climate scenario", "Measure", "Horizontal static", "Network shifting", "Network static", "Square shifting", "Square static", "Vertical static", "No MPA")
# 
# output_table_summary <- output_table_summary %>% 
#   mutate(`Climate scenario` = if_else(`Climate scenario`=="RCP8.5", "4 degrees warming", "2 degrees warming"))
# 
# kable(output_table_summary, caption="Aggregate results at the end of the century (2090-2099) for all MPA and climate scenarios. Standard deviations included in brackets. All units are in t/km^2^.")



output_table_summary <- output_table_summary %>% ungroup()
output_table_summary <- output_table_summary %>% filter(RCP=='RCP8.5') %>% select(-RCP)
colnames(output_table_summary) <- c("Measure", "Horizontal static", "Network shifting", "Network static", "Square shifting", "Square static", "Vertical static", "No MPA")

kable(output_table_summary, caption="Aggregate results at the end of the century (2090-2099) for all MPA scenarios. Standard deviations included in brackets. All units are in t/km^2^.")



```


```{r bar-chart-catch, fig.cap="Percent change in catch by fleet and target functional groups compared to no MPA scenario at the end of the 21^st^ century. Error bars represent 95% confidence intervals of the mean percent change."}

excluded_fgs <- c("Zooplankton", "Benthos", "Phytoplankton", "Detritus")

decade1 <- seq(0,9,1)
decade2 <- seq(45,54,1)
decade3 <- seq(90,99,1)

average_data <- average_data %>% 
  mutate(TimePeriod = if_else(year %in% decade1, "Today", 
                              if_else(year %in% decade2, "Mid-Century", 
                                      if_else(year %in% decade3, "End of Century", ""))))

average_data$TimePeriod <- fct_relevel(average_data$TimePeriod, "Today", "Mid-Century", "End of Century")

average_data_summary <- average_data %>%
  filter(TimePeriod != "") %>% 
  filter(!group %in% excluded_fgs) %>% 
  filter(RCP=="RCP8.5") %>% 
  group_by(group, TimePeriod, type, design, RCP) %>%
  summarize(stdev = sd(value),
            value=mean(value))

nompa_average <- average_data_summary %>% 
  ungroup() %>% 
  filter(design=="NoMPA")  %>% 
  rename(baseline=value,
         baseline_stdev = stdev) %>% 
  select(-design)
sd_num <- 1.96
average_data_summary <- average_data_summary %>% 
  ungroup() %>% 
  filter(design!="NoMPA") %>% 
  filter(TimePeriod != "Today") %>% 
  filter(TimePeriod != "Mid-Century") %>% 
  left_join(nompa_average) %>% 
  mutate(upper_bound = value + (sd_num*stdev),
         lower_bound = value - (sd_num*stdev)) %>% 
  mutate(perc_change = ((value-baseline)/baseline)*100,
         upper_bound = ((upper_bound-baseline)/baseline)*100,
         lower_bound = ((lower_bound-baseline)/baseline)*100
         )


average_data_summary$group <- gsub(average_data_summary$group, pattern=" ad", replacement= " adult")

average_data_summary$group <- fct_relevel(average_data_summary$group, c("Seiners | Mackerel adult", "Foragers | Anchovy",  "Shrimpers | Shrimp", "Trawlers | Whiting",  "Trawlers | Cod", "Sealers | Seals"), after=0)
catch_bar_plot <- average_data_summary %>% 
  left_join(mpa_labels) %>% 
  filter(type=="Average_Catch") %>% 
  ggplot(aes(x=mpa_label, y=perc_change, fill=perc_change)) +
  geom_col() +
  geom_errorbar(aes(x=mpa_label, ymin=lower_bound, ymax=upper_bound)) + 
  coord_flip() +
  xlab("MPA design") + 
  ylab("Percent change in catch") + 
  facet_wrap(~group, ncol=2, scales="free_x") + 
  scale_fill_gradientn(colors=rev(zissou_continuous)) + 
  labs(fill="Percent change") + 
  NULL

catch_bar_plot
#ggsave("./VisualOutputs/Change in catch by scenario under RCP8.5_AlternativeFormat.png", dpi=300, width=8.5, height=11, units="in")
ggsave("./Figures/Supplementary/S6_Fig.tiff", dpi=300, width=8.5, height=11, units="in")

```

FIXIT: Does the below explanation make sense? See reviewer's comment. 
At the aggregate level, the fishing effort expended in the ecosystem experiences almost no change from the baseline scenario to the MPA scenarios (Figure \@ref(fig:cpue-plot)). Effort outside MPA experiences a higher percentage increase than that in adjacent cells, which suggests the density of fish may be higher in adjacent cells, thus lowering effort. However, the effort is spatially redirected based on the cost of fishing (i.e., distance from port) and 'drawn' to areas with high biomass. This is apparent when viewing the results of the network MPAs with large edges that can be exploited by fishers. This likely makes these less effective at protecting their biomass, but improves the catch per unit effort in these areas compared to the baseline scenario. 

```{r cpue-plot, fig.cap="Percent change in catch per unit effort (CPUE) by region compared to no MPA scenario at the end of the 21st century."}

fleet_fg_table <- average_fleet_data %>% 
  select(fg, Fleet) %>% 
  unique()

mpa_spatial <- spatial_data %>% 
  left_join(mpa_data) %>% 
  left_join(mpa_legend)

effort_spat <- mpa_spatial %>% 
  filter(type=="Effort") %>% 
  rename(Effort=value,
         Fleet=fg) %>% 
  left_join(fleet_fg_table) %>% 
  select(-type)
catch_spat <- mpa_spatial %>% 
  filter(type=="Catch") %>% 
  rename(Catch=value) %>% 
  select(-type)
  

cpue <- catch_spat %>% 
  left_join(effort_spat) %>% 
  mutate(CPUE = Catch/Effort)

cpue_baseline <- cpue %>% 
  filter(design=="NoMPA") %>% 
  select(-c(design, Catch, Effort, mpa, MPA)) %>% 
  rename(Baseline=CPUE)

cpue <- cpue %>% 
  filter(design!="NoMPA") %>% 
  left_join(cpue_baseline) %>% 
  mutate(PercChange= 100*((CPUE-Baseline)/Baseline))

cpue <- cpue %>%
  filter(RCP=="RCP8.5")
#PercChange produces lots of NaN results because there is no value of effort or catch inside MPAs
# cpue <- cpue %>% 
#   mutate(RCP = if_else(RCP=="RCP8.5", "4 degrees warming", "2 degrees warming"))

cpue %>% 
  group_by(design, MPA, RCP) %>% 
  summarize(PercChange=mean(PercChange, na.rm=TRUE)) %>% 
  ungroup() %>% 
  filter(MPA!="Inside") %>% 
  left_join(mpa_labels) %>% 
  ggplot(aes(x=MPA, y=PercChange, fill=mpa_label)) +
  geom_col(position="dodge") + 
  labs(x = "Region", y = "Percent change (%)", fill = "MPA design") + 
  #facet_wrap(~RCP) + 
  NULL

#ggsave("./VisualOutputs/CPUE by RCP and MPA Design.png", dpi=300, width=8.5, height=11, units="in")
ggsave("./Figures/Supplementary/S7_Fig.tiff", dpi=300, width=8.5, height=11, units="in")


```

```{r revenue-by-area, eval=F, fig.cap='Fisheries revenue per fished cell at the end of the century.'}

catch_min_cutoff_val = 0.0001

spatial_catch_data <- spatial_catch_data %>% left_join(mpa_labels)
spatial_catch_summary = spatial_catch_data %>% 
  filter(catch > catch_min_cutoff_val) %>% 
  filter(RCP=="RCP8.5") %>% 
  group_by(mpa_label, fg, year) %>% 
  summarize(catch = sum(catch),
            value = sum(value),
            n_cells = n())

spatial_catch_combos = expand.grid(year = seq(0,100), mpa_label=mpa_labels$mpa_label, fg=price_data$fg)
spatial_catch_summary = spatial_catch_combos %>% left_join(spatial_catch_summary)
spatial_catch_summary$catch[is.na(spatial_catch_summary$catch)] <- 0
spatial_catch_summary$value[is.na(spatial_catch_summary$value)] <- 0
spatial_catch_summary$n_cells[is.na(spatial_catch_summary$n_cells)] <- 0
spatial_catch_summary <- spatial_catch_summary %>% 
  mutate(value_per_cell = value/n_cells,
         catch_per_cell = catch/n_cells)

spatial_catch_plot_summary <- spatial_catch_summary %>% 
  filter(year > 90) %>% 
  group_by(mpa_label, fg) %>% 
  summarize(value_per_cell = mean(value_per_cell),
            catch_per_cell = mean(catch_per_cell))

spatial_catch_plot_summary$mpa_label <- fct_relevel(spatial_catch_plot_summary$mpa_label, 'No MPA', after=0)
spatial_catch_plot_summary %>%  
  ggplot(aes(x=mpa_label, y=value_per_cell)) + 
  facet_wrap(~fg) + 
  coord_flip() + 
  geom_col() + 
  xlab("") + 
  ylab("Fisheries Revenue ($) Per Fished Cell") + 
  NULL
ggsave("./Figures/Supplementary/FisheriesRevenueByArea.tiff", dpi=300, width=8.5, height=11, units="in")

```


## Supplemental tables

```{r ecosystem-wide-results}
baseline_decade <- average_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year <=9) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2000s = mean(value_aggregate),
            stdev_2000s = sd(value_aggregate)) %>%
  mutate(se_2000s = stdev_2000s/sqrt(10))

end_of_century_decade <- average_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year >=90 & year <=99) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2090s = mean(value_aggregate),
            stdev_2090s = sd(value_aggregate)) %>%
  mutate(se_2090s = stdev_2090s/sqrt(10))


summary_table_revenue1 <- average_fleet_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year <= 9) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2000s = mean(value_aggregate),
            stdev_2000s = sd(value_aggregate)) %>%
  mutate(se_2000s = stdev_2000s/sqrt(10))

summary_table_revenue2 <- average_fleet_data %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  filter(year >=90 & year <=99) %>% 
  group_by(RCP, design, type) %>% 
  summarize(average_2090s = mean(value_aggregate),
            stdev_2090s = sd(value_aggregate)) %>%
  mutate(se_2090s = stdev_2090s/sqrt(10))



summary_table_temp_baseline <- baseline_decade %>% gather(key= variable, value=value, -RCP, -type, -design)
summary_table_temp_end_of_century <- end_of_century_decade %>% gather(key= variable, value=value, -RCP, -type, -design)
summary_table_temp <- rbind(summary_table_temp_baseline, summary_table_temp_end_of_century)
summary_table_temp$type <- gsub(summary_table_temp$type, pattern=".*_", replacement="")
summary_table_temp$year <- gsub(summary_table_temp$variable, pattern=".*_", replacement="")
summary_table_temp$variable <- gsub(summary_table_temp$variable, pattern="_.*", replacement="")
summary_table_temp$aggregate <- paste(summary_table_temp$RCP, summary_table_temp$design, summary_table_temp$year, sep="/")
summary_table_temp$label <- paste(summary_table_temp$design, summary_table_temp$year, sep=" ")

spread <- summary_table_temp %>%
  filter(variable != "se")  %>%
  spread(key=variable, value=value)

summary_table_biomass <- spread %>% filter(type=="Biomass")
summary_table_catch <- spread %>% filter(type=="Catch")
summary_table_effort <- spread %>% filter(type=="Effort")


summary_table_revenue2$year <- "2090s"
summary_table_revenue2$type <- "Revenue"

colnames(summary_table_revenue2) <- gsub(colnames(summary_table_revenue2), pattern="_2090s", replacement="")
agg_plot_data <- bind_rows(spread, summary_table_revenue2)


test_data <- average_data %>% 
  group_by(RCP, design, type, year) %>% 
  summarize(value_aggregate = sum(value)) %>% 
  
  filter(year >=90 & year <=99 & RCP=="RCP8.5")
test_data$design <- fct_relevel(test_data$design, "NoMPA", after=0)
linmod_biomass <- lm(value_aggregate ~ design, 
                     data=test_data %>% filter(type=="Average_Biomass"))
linmod_catch <- lm(value_aggregate ~ design, 
                   data=test_data %>% filter(type=="Average_Catch"))

tidy_model_names <- c("Variable", "Estimate", "Std. Error", "t-statistic", "p-value")

model_table <- function(model=NA){
  modeL_results <- broom::tidy(model)
  modeL_results$term <- gsub(modeL_results$term, pattern="design", replacement="")
  modeL_results <- modeL_results %>% left_join(mpa_labels, by=c('term'='design'))
  modeL_results$mpa_label[is.na(modeL_results$mpa_label)] <- "Intercept"
  modeL_results <- modeL_results %>%
    select(-term) %>% 
    select(mpa_label, everything())
  colnames(modeL_results) <- tidy_model_names
  return(modeL_results)
}

# summary(linmod_biomass)
# summary(linmod_catch)

test_data_revenue <- average_fleet_data %>% 
  filter(year >=90 & year <=99 & RCP=="RCP8.5") %>% 
  group_by(RCP, design, year, type) %>% 
  summarize(value_aggregate = sum(value))
test_data_revenue$design <- fct_relevel(test_data_revenue$design, "NoMPA", after=0)

linmod_revenue <- lm(value_aggregate ~ design, 
                     data=test_data_revenue)
# summary(linmod_revenue)

linmod_biomass_results <- model_table(linmod_biomass)
linmod_catch_results <- model_table(linmod_catch)
linmod_revenue_results <- model_table(linmod_revenue)


kable(linmod_biomass_results, digits=3, caption="Linear model results using aggregate biomass data at the end of the century (2090-2099) for all MPA and 4 degrees C warming. Units for ‘Estimate’ are  in t/km2.")
kable(linmod_catch_results, digits=3, caption="Linear model results using aggregate catch data at the end of the century (2090-2099) for all MPA and 4 degrees C warming. Units for ‘Estimate’ are  in t/km2.")
kable(linmod_revenue_results, digits=3, caption="Linear model results using aggregate revenue data at the end of the century (2090-2099) for all MPA and 4 degrees C warming. Units for ‘Estimate’ are  in $/km2.")


```

```{r ecosystem-wide-results-square-static, eval=F}

test_data$design <- fct_relevel(test_data$design, "MPA_Square_Shifting", after=0)

linmod_biomass <- lm(value_aggregate ~ design, 
                     data=test_data %>% filter(type=="Average_Biomass"))
linmod_catch <- lm(value_aggregate ~ design, 
                   data=test_data %>% filter(type=="Average_Catch"))

test_data_revenue$design <- fct_relevel(test_data_revenue$design, "MPA_Square_Shifting", after=0)
linmod_revenue <- lm(value_aggregate ~ design, 
                     data=test_data_revenue)
# summary(linmod_revenue)

linmod_biomass_results <- model_table(linmod_biomass)
linmod_catch_results <- model_table(linmod_catch)
linmod_revenue_results <- model_table(linmod_revenue)

linmod_biomass_results %>% filter(Variable=="Square Static") %>% pull('p-value')
linmod_catch_results %>% filter(Variable=="Square Static") %>% pull('p-value')
linmod_revenue_results %>% filter(Variable=="Square Static") %>% pull('p-value')

colnames(linmod_biomass_results)
```



## Supplemental figures

```{r mpa-annotate}

#Create manual borders for each MPA design
horiz_static <- tibble(design="MPA_Horiz_Static", mx1=3, mx2=16, my1=3, my2=5, ax1=1, ax2=2, ay1=1, ay2=2)
network_static1 <- tibble(design="MPA_Network_Static", mx1=8, mx2=13, my1=3, my2=4, ax1=0, ax2=2, ay1=0, ay2=2)
network_static2 <- tibble(design="MPA_Network_Static", mx1=8, mx2=13, my1=6, my2=7, ax1=0, ax2=2, ay1=0, ay2=2)
network_static3 <- tibble(design="MPA_Network_Static", mx1=8, mx2=13, my1=9, my2=11, ax1=0, ax2=2, ay1=0, ay2=2)
network_shifting1 <- tibble(design="MPA_Network_Shifting", mx1=8, mx2=13, my1=2, my2=3, ax1=0, ax2=2, ay1=0, ay2=2)
network_shifting2 <- tibble(design="MPA_Network_Shifting", mx1=8, mx2=13, my1=5, my2=6, ax1=0, ax2=2, ay1=0, ay2=2)
network_shifting3 <- tibble(design="MPA_Network_Shifting", mx1=8, mx2=13, my1=8, my2=10, ax1=0, ax2=2, ay1=0, ay2=2)
square_static <- tibble(design="MPA_Square_Static", mx1=8, mx2=13, my1=3, my2=9, ax1=0, ax2=2, ay1=0, ay2=2)
square_shifting <- tibble(design="MPA_Square_Shifting", mx1=8, mx2=13, my1=2, my2=8, ax1=0, ax2=2, ay1=0, ay2=2)
vert_static <- tibble(design="MPA_Vert_Static", mx1=9, mx2=11, my1=2, my2=15, ax1=0, ax2=2, ay1=0, ay2=2)
mpa_annotation_df <- bind_rows(horiz_static, network_static1, network_shifting1, network_static2, network_shifting2, network_static3, network_shifting3, square_static, square_shifting, vert_static)

#Then need to expand to touch the 'edges' of the MPA rather than start at the center of the cell. 
#Subtract 0.5 from min coords and add 0.5 to max coords. 
mpa_annotation_df$mx1 <- mpa_annotation_df$mx1 - 0.5
mpa_annotation_df$mx2 <- mpa_annotation_df$mx2 + 0.5
mpa_annotation_df$my1 <- mpa_annotation_df$my1 - 0.5
mpa_annotation_df$my2 <- mpa_annotation_df$my2 + 0.5

#I reverse the orientation on the map so I need to reverse the y coordinates here too:
mpa_annotation_df$my1 <- 21  - mpa_annotation_df$my1
mpa_annotation_df$my2 <- 21  - mpa_annotation_df$my2

mpa_annotation_df$ax1 <- mpa_annotation_df$mx1 - 1
mpa_annotation_df$ax2 <- mpa_annotation_df$mx2 + 1
mpa_annotation_df$ay1 <- mpa_annotation_df$my1 + 1
mpa_annotation_df$ay2 <- mpa_annotation_df$my2 - 1

#Make sure the border goes around all of the MPA (important for the network MPA designs)
mpa_annotation_df <- mpa_annotation_df %>% 
  group_by(design) %>% 
  mutate(ax1 = min(ax1),
         ay1 = max(ay1),
         ax2 = max(ax2),
         ay2 = min(ay2)) %>% 
  ungroup() 


nompa <- tibble(design="NoMPA", mx1=NA, mx2=NA, my1=NA, my2=NA, ax1=NA, ax2=NA, ay1=NA, ay2=NA)
mpa_annotation_df <- bind_rows(mpa_annotation_df, nompa) %>% 
  left_join(mpa_labels, by= "design") %>% 
  select(-design) %>% 
  rename(design=mpa_label)


```

```{r functional-groups-biomass, fig.cap="Biomass at the end of the 21^st^ century for each functional group.", fig.width= 20, fig.height=3.5, dpi=600}
mpa_spatial <- left_join(spatial_data, mpa_data)
mpa_spatial <- mpa_spatial %>% filter(RCP=="RCP8.5")
mpa_spatial$mpa[which(mpa_spatial$design=="NoMPA")] <- 0
mpa_spatial <- mpa_spatial %>% 
  left_join(mpa_legend)
mpa_spatial$MPA <- as.factor(mpa_spatial$MPA)
mpa_spatial$MPA <- fct_relevel(mpa_spatial$MPA, "Outside", after=0)
mpa_spatial$MPA <- fct_relevel(mpa_spatial$MPA, "Inside", after=1)
mpa_spatial <- mpa_spatial %>% 
  left_join(mpa_labels) %>% 
  select(-design) %>% 
  rename(design=mpa_label)
mpa_spatial$design <- fct_relevel(mpa_spatial$design, "No MPA", after=0)
mpa_spatial <- mpa_spatial %>% arrange(design)

fgs <- unique(mpa_spatial$fg)
fgs <- fgs[!grepl(fgs, pattern="ers")] #Eliminate fleets so we're just talking about functional groups. 
RCPs <- unique(mpa_spatial$RCP)
mpa_designs <- unique(mpa_spatial$design)

i = 0
for (fg_val in fgs){
  i = i + 1
  plot_names <- list()
  spatial_biomass_fg_data <- end_of_century_average(df=mpa_spatial %>% filter(type=="Biomass"), groups = fg_val)
  
  max_value <- max(spatial_biomass_fg_data %>% pull(value))
  min_value <- min(spatial_biomass_fg_data %>% pull(value))
  min_value <- floor(min_value)
  if (ceiling(max_value)!=1){
    max_value <- ceiling(max_value)
  }
  
  for (RCP_val in RCPs){
    for (design in mpa_designs){
      p <- spatial_maps_segment_plots(df=spatial_biomass_fg_data, 
                                      MPA_design=design, 
                                      type_measure="Biomass", 
                                      RCP_scenario = RCP_val)
      if(design == "No MPA" & RCP_val == "RCP2.6"){
        p <- p +
          ggtitle(label=fg_val) +
          NULL
      }
      plot_name <- paste0(fg_val, design, RCP_val, "Biomass")
      plot_names <- append(plot_names, plot_name)
      assign(plot_name, p)
    }
  }
  legend_plot <- p +
    theme(legend.position = "right") +
    labs(fill=expression("Biomass t/km"^2))
  biomass_fg_segment_legend <- cowplot::get_legend(legend_plot)
  plot_list <- mget(unlist(plot_names))
  fg_biomass_plot <- cowplot::plot_grid(plotlist = plot_list, align="h", nrow=1)
  fg_biomass_plot <- cowplot::plot_grid(fg_biomass_plot, biomass_fg_segment_legend, rel_widths = c(10,1),  align="h", nrow=1)
  print(fg_biomass_plot)
  #ggsave(paste0("./VisualOutputs/FGBiomassPlot", fg_val, ".png"), dpi=1200, height = 8, width=20)
  ggsave(paste0("./Figures/Supplementary/S", i+7,"_Fig", ".tiff"), dpi=200, height = 3.5, width=20)
}

```


```{r functional-groups-catch, fig.cap="Catch at the end of the 21^st^ century for each functional group.", fig.width= 20, fig.height=3.5, dpi=600}
catch_fgs <- c("Anchovy", "Shrimp", "Mackerel ad", "Whiting", "Cod", "Seals")
i = 0
for (fg_val in catch_fgs){
  i = i + 1
  plot_names <- list()
  spatial_catch_fg_data <- end_of_century_average(df=mpa_spatial %>% filter(type=="Catch"), groups = fg_val)
  max_value <- max(spatial_catch_fg_data %>% pull(value))
  min_value <- min(spatial_catch_fg_data %>% pull(value))
  min_value <- floor(min_value)
  if (ceiling(max_value)!=1){
    max_value <- ceiling(max_value)
  }
  for (RCP_val in RCPs){
    for (design in mpa_designs){
      p <- spatial_maps_segment_plots(df=spatial_catch_fg_data, 
                                      MPA_design=design, 
                                      type_measure="Catch", 
                                      RCP_scenario = RCP_val)
      if(design == "No MPA" & RCP_val == "RCP2.6"){
        p <- p +
          ggtitle(label=fg_val) +
          NULL
      }
      plot_name <- paste0(fg_val, design, RCP_val, "Catch")
      plot_names <- append(plot_names, plot_name)
      assign(plot_name, p)
    }
  }
  legend_plot <- p +
    theme(legend.position = "right") +
    labs(fill=expression("Catch t/km"^2))
  catch_fg_segment_legend <- cowplot::get_legend(legend_plot)
  plot_list <- mget(unlist(plot_names))
  fg_catch_plot <- cowplot::plot_grid(plotlist = plot_list, align="h", nrow=1)
  fg_catch_plot <- cowplot::plot_grid(fg_catch_plot, catch_fg_segment_legend, rel_widths = c(10,1),  align="h", nrow=1)
  print(fg_catch_plot)
  # ggsave(paste0("./VisualOutputs/FGCatchPlot", fg_val, ".png"), dpi=1200, height = 8, width=20)
  ggsave(paste0("./Figures/Supplementary/S", i+18, "_Fig",  ".tiff"), dpi=200, height = 3.5, width=20)
}

```

